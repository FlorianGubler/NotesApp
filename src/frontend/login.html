<!doctype html>
<html lang="de">

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
    type="text/css">
  <link rel="stylesheet" href="assets/css/login.css" type="text/css">
  <script src="assets/js/jquery.js"></script>
  <script src="https://use.fontawesome.com/releases/v5.9.0/js/all.js" data-auto-replace-svg></script>
  <script>$.ajaxPrefilter(function (options, originalOptions, jqXHR) { options.async = true; });</script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProMarks - Login</title>
</head>

<body>
  <div id="titlebar"></div>
  <script>
    $(function () {
      $("#titlebar").load("titlebar.html");
    });
  </script>
  <div id="loading"></div>
  <script>
    $(function () {
      $("#loading").load("loading.html");
    });
  </script>
  <div id="login" class="modal">
    <form class="modal-content animate" onsubmit="checkLogin(true); return false;">
      <div class="imgcontainer">
        <img src="assets/img/logo.png" alt="Avatar" class="avatar">
        <h2>ProMarks</h2>
      </div>
      <div class="container">
        <label for="uname"><b>E-Mail</b></label>
        <input type="email" placeholder="E-Mail eingeben" id="uname" required>

        <label for="psw"><b>Password</b></label>
        <input type="password" placeholder="Passwort eingeben" id="psw" required>

        <button type="submit">Login</button>
        <label>
          <input type="checkbox" checked="checked" id="remember"> Angemeldet bleiben
        </label>

        <a style="float: right; color: rgb(103, 103, 216); cursor: pointer;"
          onclick='window.api.send("toMain", JSON.stringify({ type: "Window", cmd: "OpenExternal", attributes: JSON.stringify("https://dekinotu.myhostpoint.ch/notes/register.php") }))'>Registrieren</a>

        <p style='background-color: red;display: none;' id='login-response-false'>Login failed</p>

      </div>

      <div class="container" style="background-color:#404142">
        <span class="psw"><a href="mailto:gubler.florian@gmx.net">Passwort vergessen</a></span>
      </div>
    </form>
  </div>

  <div id="internet-connection-failed">
    <img src="assets/img/ban.svg" alt="ban-icon">
    <p>Es konnte keine Verbindung zum Server hergestellt werden</p>
  </div>

  <div id="retry" onclick="location.reload(true)">
    <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd"><path d="M7 9h-7v-7h1v5.2c1.853-4.237 6.083-7.2 11-7.2 6.623 0 12 5.377 12 12s-5.377 12-12 12c-6.286 0-11.45-4.844-11.959-11h1.004c.506 5.603 5.221 10 10.955 10 6.071 0 11-4.929 11-11s-4.929-11-11-11c-4.66 0-8.647 2.904-10.249 7h5.249v1z"/></svg>
    <p>Wiederholen</p>
</div>

  <script>

    document.getElementById("login").style.display = "none";
    document.getElementById("loading").style.display = "block";

    window.api.receive("internet-connection-error", (args) => {
      if (args.CONNECTION == "FAILED") {
        document.getElementById("internet-connection-failed").style.display = "flex";
        document.getElementById("retry").style.display = "flex";

      }
    });

    //AutoLogin Check
    window.api.send("toMain", JSON.stringify({ type: 'CheckData', cmd: 'AutoLogin', attributes: "" }));
    window.api.receive("fromMainA", (args) => {
      if (args.type == "replyLogin") {
        var response = JSON.parse(args.attributes);
        if (response) {
          location.href = "home.html"
        }
        else {
          document.getElementById("login").style.display = "block";
          document.getElementById("loading").style.display = "none";
        }
      }
    });

    function checkLogin(showError) {
      window.api.send("toMain", JSON.stringify({ type: 'CheckData', cmd: 'Login', attributes: JSON.stringify({ email: document.getElementById('uname').value, password: document.getElementById('psw').value, remember: document.getElementById('remember').checked }) }));
      window.api.receive("fromMainA", (args) => {
        if (args.type == "replyLogin") {
          var response = JSON.parse(args.attributes);
          if (response) {
            location.href = "home.html"
          }
          else if (showError) {
            document.getElementById("login-response-false").style.display = "block";
          }
        }
      });
    }
  </script>
</body>

</html>